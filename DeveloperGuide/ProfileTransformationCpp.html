<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Creating a profile transformation in C++ | QIR Adaptor Tool Developer Documentation</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/qat/assets/css/0.styles.9ffaf24c.css" as="style"><link rel="preload" href="/qat/assets/js/app.095a458a.js" as="script"><link rel="preload" href="/qat/assets/js/2.c16f4dee.js" as="script"><link rel="preload" href="/qat/assets/js/62.56d7d941.js" as="script"><link rel="prefetch" href="/qat/assets/js/10.ca67c9fc.js"><link rel="prefetch" href="/qat/assets/js/100.fa1e3de5.js"><link rel="prefetch" href="/qat/assets/js/101.a303e4a1.js"><link rel="prefetch" href="/qat/assets/js/102.d7505516.js"><link rel="prefetch" href="/qat/assets/js/103.94a7645e.js"><link rel="prefetch" href="/qat/assets/js/104.494a3276.js"><link rel="prefetch" href="/qat/assets/js/105.b08b3174.js"><link rel="prefetch" href="/qat/assets/js/106.e60966eb.js"><link rel="prefetch" href="/qat/assets/js/107.5860da95.js"><link rel="prefetch" href="/qat/assets/js/108.89416570.js"><link rel="prefetch" href="/qat/assets/js/109.916384ce.js"><link rel="prefetch" href="/qat/assets/js/11.17cef0d0.js"><link rel="prefetch" href="/qat/assets/js/110.749f477f.js"><link rel="prefetch" href="/qat/assets/js/111.92f4dc98.js"><link rel="prefetch" href="/qat/assets/js/112.7a496ea4.js"><link rel="prefetch" href="/qat/assets/js/113.12462969.js"><link rel="prefetch" href="/qat/assets/js/114.e07bef58.js"><link rel="prefetch" href="/qat/assets/js/115.0588ee56.js"><link rel="prefetch" href="/qat/assets/js/116.1cf0f7ac.js"><link rel="prefetch" href="/qat/assets/js/117.9ce8b6e0.js"><link rel="prefetch" href="/qat/assets/js/118.97eb40a5.js"><link rel="prefetch" href="/qat/assets/js/119.d8166ef5.js"><link rel="prefetch" href="/qat/assets/js/12.24429e42.js"><link rel="prefetch" href="/qat/assets/js/120.3e0f5345.js"><link rel="prefetch" href="/qat/assets/js/121.52fc955d.js"><link rel="prefetch" href="/qat/assets/js/122.9b11093b.js"><link rel="prefetch" href="/qat/assets/js/123.3d5484c6.js"><link rel="prefetch" href="/qat/assets/js/124.fd335bcc.js"><link rel="prefetch" href="/qat/assets/js/125.687d26ff.js"><link rel="prefetch" href="/qat/assets/js/126.0a02a10d.js"><link rel="prefetch" href="/qat/assets/js/127.f034a973.js"><link rel="prefetch" href="/qat/assets/js/128.039d9dd0.js"><link rel="prefetch" href="/qat/assets/js/129.e4321e17.js"><link rel="prefetch" href="/qat/assets/js/13.8f12c582.js"><link rel="prefetch" href="/qat/assets/js/130.5aec9f46.js"><link rel="prefetch" href="/qat/assets/js/131.d14a045c.js"><link rel="prefetch" href="/qat/assets/js/132.5c6eafcf.js"><link rel="prefetch" href="/qat/assets/js/133.0dbdfe29.js"><link rel="prefetch" href="/qat/assets/js/134.eaf99e9e.js"><link rel="prefetch" href="/qat/assets/js/135.25570d9a.js"><link rel="prefetch" href="/qat/assets/js/136.2466d3a9.js"><link rel="prefetch" href="/qat/assets/js/137.96f2f8cf.js"><link rel="prefetch" href="/qat/assets/js/138.23be8872.js"><link rel="prefetch" href="/qat/assets/js/139.865b4eaf.js"><link rel="prefetch" href="/qat/assets/js/14.9bfd8aa8.js"><link rel="prefetch" href="/qat/assets/js/140.70eb718a.js"><link rel="prefetch" href="/qat/assets/js/141.1f6c40d8.js"><link rel="prefetch" href="/qat/assets/js/142.118e196f.js"><link rel="prefetch" href="/qat/assets/js/143.0a60ac15.js"><link rel="prefetch" href="/qat/assets/js/144.da08cc0b.js"><link rel="prefetch" href="/qat/assets/js/145.85578c75.js"><link rel="prefetch" href="/qat/assets/js/146.2881e068.js"><link rel="prefetch" href="/qat/assets/js/147.4df56b19.js"><link rel="prefetch" href="/qat/assets/js/148.36afd77b.js"><link rel="prefetch" href="/qat/assets/js/149.52078f4c.js"><link rel="prefetch" href="/qat/assets/js/15.5a546cc1.js"><link rel="prefetch" href="/qat/assets/js/150.1bce48aa.js"><link rel="prefetch" href="/qat/assets/js/151.328fbf45.js"><link rel="prefetch" href="/qat/assets/js/152.f4a4de22.js"><link rel="prefetch" href="/qat/assets/js/153.6878d3c4.js"><link rel="prefetch" href="/qat/assets/js/154.7f1d05e5.js"><link rel="prefetch" href="/qat/assets/js/155.a0c4e908.js"><link rel="prefetch" href="/qat/assets/js/156.60f7f4a2.js"><link rel="prefetch" href="/qat/assets/js/157.29fb13cb.js"><link rel="prefetch" href="/qat/assets/js/158.a9da5736.js"><link rel="prefetch" href="/qat/assets/js/159.006fa2a3.js"><link rel="prefetch" href="/qat/assets/js/16.5cf533bc.js"><link rel="prefetch" href="/qat/assets/js/160.d67d343d.js"><link rel="prefetch" href="/qat/assets/js/161.5cb4bd9e.js"><link rel="prefetch" href="/qat/assets/js/162.165cd909.js"><link rel="prefetch" href="/qat/assets/js/163.21014511.js"><link rel="prefetch" href="/qat/assets/js/164.ae2e1f04.js"><link rel="prefetch" href="/qat/assets/js/165.71b7d1c3.js"><link rel="prefetch" href="/qat/assets/js/166.cfae4028.js"><link rel="prefetch" href="/qat/assets/js/167.5d1bdeeb.js"><link rel="prefetch" href="/qat/assets/js/168.aeade6b5.js"><link rel="prefetch" href="/qat/assets/js/169.0fc489bd.js"><link rel="prefetch" href="/qat/assets/js/17.899b8caf.js"><link rel="prefetch" href="/qat/assets/js/170.323fc4bb.js"><link rel="prefetch" href="/qat/assets/js/171.f752fd79.js"><link rel="prefetch" href="/qat/assets/js/172.d034ded1.js"><link rel="prefetch" href="/qat/assets/js/173.40da22cd.js"><link rel="prefetch" href="/qat/assets/js/174.a2b2ee43.js"><link rel="prefetch" href="/qat/assets/js/175.b980d373.js"><link rel="prefetch" href="/qat/assets/js/176.a966a0c0.js"><link rel="prefetch" href="/qat/assets/js/177.6aead1a3.js"><link rel="prefetch" href="/qat/assets/js/178.d586ad19.js"><link rel="prefetch" href="/qat/assets/js/179.2d38da52.js"><link rel="prefetch" href="/qat/assets/js/18.c7711af4.js"><link rel="prefetch" href="/qat/assets/js/180.ebdd713f.js"><link rel="prefetch" href="/qat/assets/js/181.9915bc0b.js"><link rel="prefetch" href="/qat/assets/js/182.b0409d66.js"><link rel="prefetch" href="/qat/assets/js/183.b0356262.js"><link rel="prefetch" href="/qat/assets/js/184.a7ce7d21.js"><link rel="prefetch" href="/qat/assets/js/185.f3c8f942.js"><link rel="prefetch" href="/qat/assets/js/186.54ab626c.js"><link rel="prefetch" href="/qat/assets/js/187.cc6c94e8.js"><link rel="prefetch" href="/qat/assets/js/188.cf2b5f45.js"><link rel="prefetch" href="/qat/assets/js/189.f7e141b8.js"><link rel="prefetch" href="/qat/assets/js/19.8487c2a1.js"><link rel="prefetch" href="/qat/assets/js/190.e3fef916.js"><link rel="prefetch" href="/qat/assets/js/191.728c2159.js"><link rel="prefetch" href="/qat/assets/js/192.5d54991d.js"><link rel="prefetch" href="/qat/assets/js/193.365650d4.js"><link rel="prefetch" href="/qat/assets/js/194.10925be4.js"><link rel="prefetch" href="/qat/assets/js/195.cd2dc82c.js"><link rel="prefetch" href="/qat/assets/js/196.17eca47b.js"><link rel="prefetch" href="/qat/assets/js/197.8bae1545.js"><link rel="prefetch" href="/qat/assets/js/198.1b130f84.js"><link rel="prefetch" href="/qat/assets/js/199.6c49188f.js"><link rel="prefetch" href="/qat/assets/js/20.ce597c5e.js"><link rel="prefetch" href="/qat/assets/js/200.b2915555.js"><link rel="prefetch" href="/qat/assets/js/201.c1c21d9a.js"><link rel="prefetch" href="/qat/assets/js/202.1b9e47a7.js"><link rel="prefetch" href="/qat/assets/js/203.37c8de57.js"><link rel="prefetch" href="/qat/assets/js/204.1686331e.js"><link rel="prefetch" href="/qat/assets/js/205.9d5389d5.js"><link rel="prefetch" href="/qat/assets/js/206.3b70f0c2.js"><link rel="prefetch" href="/qat/assets/js/207.ad61ee16.js"><link rel="prefetch" href="/qat/assets/js/208.cecd5551.js"><link rel="prefetch" href="/qat/assets/js/209.79b24ee6.js"><link rel="prefetch" href="/qat/assets/js/21.c2cfdae3.js"><link rel="prefetch" href="/qat/assets/js/22.edf81d2f.js"><link rel="prefetch" href="/qat/assets/js/23.81a4380d.js"><link rel="prefetch" href="/qat/assets/js/24.1dd0cec6.js"><link rel="prefetch" href="/qat/assets/js/25.2e0d2297.js"><link rel="prefetch" href="/qat/assets/js/26.63f3e4ae.js"><link rel="prefetch" href="/qat/assets/js/27.c274073b.js"><link rel="prefetch" href="/qat/assets/js/28.ca0a245e.js"><link rel="prefetch" href="/qat/assets/js/29.87c59657.js"><link rel="prefetch" href="/qat/assets/js/3.03284f30.js"><link rel="prefetch" href="/qat/assets/js/30.db000092.js"><link rel="prefetch" href="/qat/assets/js/31.190df5b6.js"><link rel="prefetch" href="/qat/assets/js/32.901b2885.js"><link rel="prefetch" href="/qat/assets/js/33.8c010e64.js"><link rel="prefetch" href="/qat/assets/js/34.c0602864.js"><link rel="prefetch" href="/qat/assets/js/35.be5a8e74.js"><link rel="prefetch" href="/qat/assets/js/36.1d524ebe.js"><link rel="prefetch" href="/qat/assets/js/37.33950672.js"><link rel="prefetch" href="/qat/assets/js/38.ca665f48.js"><link rel="prefetch" href="/qat/assets/js/39.286b129a.js"><link rel="prefetch" href="/qat/assets/js/4.83fce895.js"><link rel="prefetch" href="/qat/assets/js/40.0892c721.js"><link rel="prefetch" href="/qat/assets/js/41.3ec2fd04.js"><link rel="prefetch" href="/qat/assets/js/42.0957aff3.js"><link rel="prefetch" href="/qat/assets/js/43.a7618f9f.js"><link rel="prefetch" href="/qat/assets/js/44.0422424c.js"><link rel="prefetch" href="/qat/assets/js/45.e8ad4c53.js"><link rel="prefetch" href="/qat/assets/js/46.b17c8d8d.js"><link rel="prefetch" href="/qat/assets/js/47.dd5daf10.js"><link rel="prefetch" href="/qat/assets/js/48.695a8003.js"><link rel="prefetch" href="/qat/assets/js/49.d85e6101.js"><link rel="prefetch" href="/qat/assets/js/5.33a173f2.js"><link rel="prefetch" href="/qat/assets/js/50.9d4e204c.js"><link rel="prefetch" href="/qat/assets/js/51.6c15c4a6.js"><link rel="prefetch" href="/qat/assets/js/52.2fc812f3.js"><link rel="prefetch" href="/qat/assets/js/53.eee2140d.js"><link rel="prefetch" href="/qat/assets/js/54.f8028da4.js"><link rel="prefetch" href="/qat/assets/js/55.c947887d.js"><link rel="prefetch" href="/qat/assets/js/56.b45006d7.js"><link rel="prefetch" href="/qat/assets/js/57.7b686ea1.js"><link rel="prefetch" href="/qat/assets/js/58.82f0ffee.js"><link rel="prefetch" href="/qat/assets/js/59.4adba173.js"><link rel="prefetch" href="/qat/assets/js/6.7a505dc8.js"><link rel="prefetch" href="/qat/assets/js/60.dc093b25.js"><link rel="prefetch" href="/qat/assets/js/61.32f169d5.js"><link rel="prefetch" href="/qat/assets/js/63.f4073a80.js"><link rel="prefetch" href="/qat/assets/js/64.988e3c0b.js"><link rel="prefetch" href="/qat/assets/js/65.b4a5075d.js"><link rel="prefetch" href="/qat/assets/js/66.7f3f0e65.js"><link rel="prefetch" href="/qat/assets/js/67.faacfdb5.js"><link rel="prefetch" href="/qat/assets/js/68.f689f608.js"><link rel="prefetch" href="/qat/assets/js/69.c646d14b.js"><link rel="prefetch" href="/qat/assets/js/7.14b60190.js"><link rel="prefetch" href="/qat/assets/js/70.6b6f39f1.js"><link rel="prefetch" href="/qat/assets/js/71.281d47e1.js"><link rel="prefetch" href="/qat/assets/js/72.3e076da8.js"><link rel="prefetch" href="/qat/assets/js/73.1e46b698.js"><link rel="prefetch" href="/qat/assets/js/74.d20dd1f7.js"><link rel="prefetch" href="/qat/assets/js/75.558c161c.js"><link rel="prefetch" href="/qat/assets/js/76.5fca2088.js"><link rel="prefetch" href="/qat/assets/js/77.06456bde.js"><link rel="prefetch" href="/qat/assets/js/78.a3cfd616.js"><link rel="prefetch" href="/qat/assets/js/79.98b708e7.js"><link rel="prefetch" href="/qat/assets/js/8.16f6f26a.js"><link rel="prefetch" href="/qat/assets/js/80.41aa79b1.js"><link rel="prefetch" href="/qat/assets/js/81.5dd0b5ba.js"><link rel="prefetch" href="/qat/assets/js/82.5d453ca9.js"><link rel="prefetch" href="/qat/assets/js/83.6e5bf8d0.js"><link rel="prefetch" href="/qat/assets/js/84.a5fe4edf.js"><link rel="prefetch" href="/qat/assets/js/85.ead7afd3.js"><link rel="prefetch" href="/qat/assets/js/86.0894f8c4.js"><link rel="prefetch" href="/qat/assets/js/87.0b127aa0.js"><link rel="prefetch" href="/qat/assets/js/88.c518bdff.js"><link rel="prefetch" href="/qat/assets/js/89.a999ea82.js"><link rel="prefetch" href="/qat/assets/js/9.35501b87.js"><link rel="prefetch" href="/qat/assets/js/90.3157253b.js"><link rel="prefetch" href="/qat/assets/js/91.0ef2ceba.js"><link rel="prefetch" href="/qat/assets/js/92.fdf0074d.js"><link rel="prefetch" href="/qat/assets/js/93.9b08604a.js"><link rel="prefetch" href="/qat/assets/js/94.0d663c39.js"><link rel="prefetch" href="/qat/assets/js/95.438766ea.js"><link rel="prefetch" href="/qat/assets/js/96.dde37349.js"><link rel="prefetch" href="/qat/assets/js/97.1ca24c5b.js"><link rel="prefetch" href="/qat/assets/js/98.29827c66.js"><link rel="prefetch" href="/qat/assets/js/99.f859f6ff.js">
    <link rel="stylesheet" href="/qat/assets/css/0.styles.9ffaf24c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/qat/" class="home-link router-link-active"><!----> <span class="site-name">QIR Adaptor Tool Developer Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/qat/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/qat/Classes/" class="nav-link">
  Classes
</a></div><div class="nav-item"><a href="/qat/Namespaces/" class="nav-link">
  Namespaces
</a></div><div class="nav-item"><a href="/qat/Modules/" class="nav-link">
  Modules
</a></div><div class="nav-item"><a href="/qat/Files/" class="nav-link">
  Files
</a></div><div class="nav-item"><a href="/qat/Pages/" class="nav-link">
  Pages
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/qat/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/qat/Classes/" class="nav-link">
  Classes
</a></div><div class="nav-item"><a href="/qat/Namespaces/" class="nav-link">
  Namespaces
</a></div><div class="nav-item"><a href="/qat/Modules/" class="nav-link">
  Modules
</a></div><div class="nav-item"><a href="/qat/Files/" class="nav-link">
  Files
</a></div><div class="nav-item"><a href="/qat/Pages/" class="nav-link">
  Pages
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="creating-a-profile-transformation-in-c"><a href="#creating-a-profile-transformation-in-c" class="header-anchor">#</a> Creating a profile transformation in C++</h1> <h2 id="profile-transformation-as-pass"><a href="#profile-transformation-as-pass" class="header-anchor">#</a> Profile transformation as pass</h2> <p>As an example of how one can implement a new profile pass, we here show the implementation details of our example pass which allows mapping the teleportation code to the base profile:</p> <div class="language-c++ extra-class"><pre class="language-text"><code>        pb.registerPipelineParsingCallback([](StringRef name, FunctionPassManager &amp;fpm,
                                              ArrayRef&lt;PassBuilder::PipelineElement&gt; /*unused*/) {
          // Base profile
          if (name == &quot;restrict-qir&lt;base-profile&gt;&quot;)
          {
            RuleSet rule_set;

            // Defining the mapping
            auto factory = RuleFactory(rule_set);

            factory.useStaticQuantumArrayAllocation();
            factory.useStaticQuantumAllocation();
            factory.useStaticResultAllocation();

            factory.optimiseBranchQuatumOne();
            //  factory.optimiseBranchQuatumZero();

            factory.disableReferenceCounting();
            factory.disableAliasCounting();
            factory.disableStringSupport();

            fpm.addPass(TransformationRulePass(std::move(rule_set)));
            return true;
          }

          return false;
        });
      }};
</code></pre></div><p>Transformations of the IR will happen on the basis of what rules are added to the rule set. The purpose of the factory is to make easy to add rules that serve a single purpose as well as making a basis for making rules unit testable.</p> <h2 id="implementing-new-rules"><a href="#implementing-new-rules" class="header-anchor">#</a> Implementing new rules</h2> <p>Implementing new rules consists of two steps: Defining a pattern that one wish to replace and implementing the corresponding replacement logic. Inside a factory member function, this look as follows:</p> <div class="language-c++ extra-class"><pre class="language-text"><code>  auto get_element =
      Call(&quot;__quantum__rt__array_get_element_ptr_1d&quot;, &quot;arrayName&quot;_cap = _, &quot;index&quot;_cap = _);
  auto cast_pattern = BitCast(&quot;getElement&quot;_cap = get_element);
  auto load_pattern = Load(&quot;cast&quot;_cap = cast_pattern);

  addRule({std::move(load_pattern), access_replacer});
</code></pre></div><p>where <code>addRule</code> adds the rule to the current rule set.</p> <h2 id="capturing-patterns"><a href="#capturing-patterns" class="header-anchor">#</a> Capturing patterns</h2> <p>The pattern defined in this snippet matches IR like:</p> <div class="language-c++ extra-class"><pre class="language-text"><code>  %0 = call i8* @__quantum__rt__array_get_element_ptr_1d(%Array* %leftPreshared, i64 0)
  %1 = bitcast i8* %0 to %Qubit**
  %2 = load %Qubit*, %Qubit** %1, align 8
</code></pre></div><p>In the above rule, the first and a second argument of <code>__quantum__rt__array_get_element_ptr_1d</code> is captured as <code>arrayName</code> and <code>index</code>, respectively. Likewise, the bitcast instruction is captured as <code>cast</code>. Each of these captures will be available inside the replacement function <code>access_replacer</code>.</p> <h2 id="implementing-replacement-logic"><a href="#implementing-replacement-logic" class="header-anchor">#</a> Implementing replacement logic</h2> <p>After a positive match is found, the lead instruction alongside a IRBuilder, a capture table and a replacement table is passed to the replacement function. Here is an example on how one can access the captured variables to perform a transformation of the IR:</p> <div class="language-c++ extra-class"><pre class="language-text"><code>  auto access_replacer = [qubit_alloc_manager](Builder &amp;builder, Value *val, Captures &amp;cap,
                                               Replacements &amp;replacements) {
    // ...
    auto cst = llvm::dyn_cast&lt;llvm::ConstantInt&gt;(cap[&quot;index&quot;]);
    // ...
    auto llvm_size = cst-&gt;getValue();
    auto offset    = qubit_alloc_manager-&gt;getOffset(cap[&quot;arrayName&quot;]-&gt;getName().str());

    auto idx = llvm::APInt(llvm_size.getBitWidth(), llvm_size.getZExtValue() + offset);
    auto new_index = llvm::ConstantInt::get(builder.getContext(), idx);
    auto instr = new llvm::IntToPtrInst(new_index, ptr_type);
    instr-&gt;takeName(val);

    // Replacing the lead instruction with a the new instruction
    replacements.push_back({llvm::dyn_cast&lt;Instruction&gt;(val), instr});

    // Deleting the getelement and cast operations
    replacements.push_back({llvm::dyn_cast&lt;Instruction&gt;(cap[&quot;getElement&quot;]), nullptr});
    replacements.push_back({llvm::dyn_cast&lt;Instruction&gt;(cap[&quot;cast&quot;]), nullptr});

    return true;
  };
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/qat/assets/js/app.095a458a.js" defer></script><script src="/qat/assets/js/2.c16f4dee.js" defer></script><script src="/qat/assets/js/62.56d7d941.js" defer></script>
  </body>
</html>
